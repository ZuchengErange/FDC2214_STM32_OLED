#include "OLED.h"
#include "delay.h"
#include "stm32f10x_gpio.h"
#include "sys.h"

#if CONNECTION==0//IIC
#include "IIC.h"
#endif

#if CONNECTION==2//硬件SPI
#include "SPI.h"
#endif

#ifdef OLED_HAVE_FLASH
#include "ff.h"
FIL FontFile;
#endif

#ifdef FONT_6_8
unsigned char const F6x8[][6] =//6*8的点阵
{
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,// sp
	0x00, 0x00, 0x00, 0x2f, 0x00, 0x00,// !
	0x00, 0x00, 0x07, 0x00, 0x07, 0x00,// "
	0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14,// #
	0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12,// $
	0x00, 0x62, 0x64, 0x08, 0x13, 0x23,// %
	0x00, 0x36, 0x49, 0x55, 0x22, 0x50,// &
	0x00, 0x00, 0x05, 0x03, 0x00, 0x00,// '
	0x00, 0x00, 0x1c, 0x22, 0x41, 0x00,// (
	0x00, 0x00, 0x41, 0x22, 0x1c, 0x00,// )
	0x00, 0x14, 0x08, 0x3E, 0x08, 0x14,// *
	0x00, 0x08, 0x08, 0x3E, 0x08, 0x08,// +
	0x00, 0x00, 0x00, 0xA0, 0x60, 0x00,// ,
	0x00, 0x08, 0x08, 0x08, 0x08, 0x08,// -
	0x00, 0x00, 0x60, 0x60, 0x00, 0x00,// .
	0x00, 0x20, 0x10, 0x08, 0x04, 0x02,// /
	0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
	0x00, 0x00, 0x42, 0x7F, 0x40, 0x00,// 1
	0x00, 0x42, 0x61, 0x51, 0x49, 0x46,// 2
	0x00, 0x21, 0x41, 0x45, 0x4B, 0x31,// 3
	0x00, 0x18, 0x14, 0x12, 0x7F, 0x10,// 4
	0x00, 0x27, 0x45, 0x45, 0x45, 0x39,// 5
	0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
	0x00, 0x01, 0x71, 0x09, 0x05, 0x03,// 7
	0x00, 0x36, 0x49, 0x49, 0x49, 0x36,// 8
	0x00, 0x06, 0x49, 0x49, 0x29, 0x1E,// 9
	0x00, 0x00, 0x36, 0x36, 0x00, 0x00,// :
	0x00, 0x00, 0x56, 0x36, 0x00, 0x00,// ;
	0x00, 0x08, 0x14, 0x22, 0x41, 0x00,// <
	0x00, 0x14, 0x14, 0x14, 0x14, 0x14,// =
	0x00, 0x00, 0x41, 0x22, 0x14, 0x08,// >
	0x00, 0x02, 0x01, 0x51, 0x09, 0x06,// ?
	0x00, 0x32, 0x49, 0x59, 0x51, 0x3E,// @
	0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C,// A
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x36,// B
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x22,// C
	0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C,// D
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x41,// E
	0x00, 0x7F, 0x09, 0x09, 0x09, 0x01,// F
	0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A,// G
	0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F,// H
	0x00, 0x00, 0x41, 0x7F, 0x41, 0x00,// I
	0x00, 0x20, 0x40, 0x41, 0x3F, 0x01,// J
	0x00, 0x7F, 0x08, 0x14, 0x22, 0x41,// K
	0x00, 0x7F, 0x40, 0x40, 0x40, 0x40,// L
	0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F,// M
	0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F,// N
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E,// O
	0x00, 0x7F, 0x09, 0x09, 0x09, 0x06,// P
	0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
	0x00, 0x7F, 0x09, 0x19, 0x29, 0x46,// R
	0x00, 0x46, 0x49, 0x49, 0x49, 0x31,// S
	0x00, 0x01, 0x01, 0x7F, 0x01, 0x01,// T
	0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F,// U
	0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F,// V
	0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F,// W
	0x00, 0x63, 0x14, 0x08, 0x14, 0x63,// X
	0x00, 0x07, 0x08, 0x70, 0x08, 0x07,// Y
	0x00, 0x61, 0x51, 0x49, 0x45, 0x43,// Z
	0x00, 0x00, 0x7F, 0x41, 0x41, 0x00,// [
	0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55,// 55
	0x00, 0x00, 0x41, 0x41, 0x7F, 0x00,// ]
	0x00, 0x04, 0x02, 0x01, 0x02, 0x04,// ^
	0x00, 0x40, 0x40, 0x40, 0x40, 0x40,// _
	0x00, 0x00, 0x01, 0x02, 0x04, 0x00,// '
	0x00, 0x20, 0x54, 0x54, 0x54, 0x78,// a
	0x00, 0x7F, 0x48, 0x44, 0x44, 0x38,// b
	0x00, 0x38, 0x44, 0x44, 0x44, 0x20,// c
	0x00, 0x38, 0x44, 0x44, 0x48, 0x7F,// d
	0x00, 0x38, 0x54, 0x54, 0x54, 0x18,// e
	0x00, 0x08, 0x7E, 0x09, 0x01, 0x02,// f
	0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C,// g
	0x00, 0x7F, 0x08, 0x04, 0x04, 0x78,// h
	0x00, 0x00, 0x44, 0x7D, 0x40, 0x00,// i
	0x00, 0x40, 0x80, 0x84, 0x7D, 0x00,// j
	0x00, 0x7F, 0x10, 0x28, 0x44, 0x00,// k
	0x00, 0x00, 0x41, 0x7F, 0x40, 0x00,// l
	0x00, 0x7C, 0x04, 0x18, 0x04, 0x78,// m
	0x00, 0x7C, 0x08, 0x04, 0x04, 0x78,// n
	0x00, 0x38, 0x44, 0x44, 0x44, 0x38,// o
	0x00, 0xFC, 0x24, 0x24, 0x24, 0x18,// p
	0x00, 0x18, 0x24, 0x24, 0x18, 0xFC,// q
	0x00, 0x7C, 0x08, 0x04, 0x04, 0x08,// r
	0x00, 0x48, 0x54, 0x54, 0x54, 0x20,// s
	0x00, 0x04, 0x3F, 0x44, 0x40, 0x20,// t
	0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C,// u
	0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C,// v
	0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C,// w
	0x00, 0x44, 0x28, 0x10, 0x28, 0x44,// x
	0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C,// y
	0x00, 0x44, 0x64, 0x54, 0x4C, 0x44,// z
	0x14, 0x14, 0x14, 0x14, 0x14, 0x14,// ~
};
#endif

#ifdef FONT_8_16
unsigned char const F8X16[][16]=//8*16的点阵	  
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 0
	0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00,//! 1
	0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//" 2
	0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00,//# 3
	0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00,//$ 4
	0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00,//% 5
	0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10,//& 6
	0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//' 7
	0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,//( 8
	0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00,//) 9
	0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00,//* 10
	0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00,//+ 11
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00,//, 12
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,//- 13
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,//. 14
	0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00,/// 15
	0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,//0 16
	0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//1 17
	0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,//2 18
	0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,//3 19
	0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,//4 20
	0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,//5 21
	0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,//6 22
	0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,//7 23
	0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,//8 24
	0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,//9 25
	0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,//: 26
	0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00,//; 27
	0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00,//< 28
	0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,//= 29
	0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00,//> 30
	0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00,//? 31
	0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00,//@ 32
	0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,//A 33
	0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,//B 34
	0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,//C 35
	0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,//D 36
	0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,//E 37
	0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,//F 38
	0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,//G 39
	0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,//H 40
	0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//I 41
	0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,//J 42
	0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,//K 43
	0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,//L 44
	0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,//M 45
	0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,//N 46
	0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,//O 47
	0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,//P 48
	0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,//Q 49
	0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,//R 50
	0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,//S 51
	0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//T 52
	0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,//U 53
	0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,//V 54
	0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,//W 55
	0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,//X 56
	0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//Y 57
	0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,//Z 58
	0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,//[ 59
	0x00,0x0C,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xC0,0x00,//\ 60
	0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,//] 61
	0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//^ 62
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,//_ 63
	0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//` 64
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20,//a 65
	0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00,//b 66
	0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00,//c 67
	0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20,//d 68
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00,//e 69
	0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x18,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//f 70
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00,//g 71
	0x08,0xF8,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,//h 72
	0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//i 73
	0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,//j 74
	0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00,//k 75
	0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//l 76
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F,//m 77
	0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,//n 78
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,//o 79
	0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00,//p 80
	0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0x20,0xA0,0xFF,0x80,//q 81
	0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00,//r 82
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00,//s 83
	0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00,//t 84
	0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20,//u 85
	0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00,//v 86
	0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00,//w 87
	0x00,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00,//x 88
	0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x8E,0x70,0x18,0x06,0x01,0x00,//y 89
	0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00,//z 90
	0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40,//{ 91
	0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,//| 92
	0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00,//} 93
	0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//~ 94
};
#endif

#if CONNECTION==2//硬件SPI
void OLED_cmd(unsigned char byte)
{
	while(!SPI_SendBusy(OLED_HW_SPI));//等待发送完成
   OLED_DC = 0;//发送指令
	SPI_Buff(OLED_HW_SPI) = byte;//发送一个字节
}

void OLED_dat(unsigned char byte)
{
	while(!SPI_SendBusy(OLED_HW_SPI));//等待发送完成
   OLED_DC = 1;//发送数据
	SPI_Buff(OLED_HW_SPI) = byte;//发送一个字节
}
#endif

#if CONNECTION==1//软件SPI
__inline void OLED_cmd(unsigned char byte)
{
	unsigned char i;
	OLED_DC = 0;
	for(i = 0;i < 8;i ++) //发送一个八位数据 
	{
		OLED_SCL = 0;
		if(byte & 0x80)
		{
			OLED_SDA = 1;
		}
		else
		{
			OLED_SDA = 0;
		}
		OLED_SCL = 1;
		byte = byte << 1;
	}
}

__inline void OLED_dat(unsigned char byte)
{
	unsigned char i;
	OLED_DC = 1;
	for(i = 0;i < 8;i ++) //发送一个八位数据 
	{
		OLED_SCL = 0;
		if(byte & 0x80)
		{
			OLED_SDA = 1;
		}
		else
		{
			OLED_SDA = 0;
		}
		OLED_SCL = 1;
		byte = byte << 1;
	}
}
#endif

#if CONNECTION==0//IIC
void OLED_dat(unsigned char byte)//OLED写入数据
{
	IIC_Start();
	IIC_Send_Byte(OLED_ADDR);
	IIC_NAck();
	IIC_Send_Byte(0x40);//写入数据
	IIC_NAck();
	IIC_Send_Byte(byte);
	IIC_NAck();
	IIC_Stop();
}

void OLED_cmd(unsigned char byte)//OLED写入指令
{
	IIC_Start();
	IIC_Send_Byte(OLED_ADDR);
	IIC_NAck();
	IIC_Send_Byte(0x00);//写入指令
	IIC_NAck();
	IIC_Send_Byte(byte);
	IIC_NAck();
	IIC_Stop();
}
#endif

void OLED_Port_Init(void)//初始化OLED接口
{
	GPIO_InitTypeDef GPIO_InitStructure;
	
	RCC_APB2PeriphClockCmd(OLED_GPIO_Init,ENABLE);
	GPIO_InitStructure.GPIO_Pin = 0;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	
	#if CONNECTION!=0//不是IIC
	GPIO_InitStructure.GPIO_Pin = OLED_RST_Init | OLED_DC_Init;
	#endif
	
	#if CONNECTION==1//不是硬件SPI
	GPIO_InitStructure.GPIO_Pin |= (OLED_SCL_Init | OLED_SDA_Init);//SCK&MOSI
	#endif
	
	GPIO_Init(OLED_PORT,&GPIO_InitStructure);
}

void OLED_contrast(unsigned char contrast)//设定对比度，0-255
{
	OLED_cmd(0x81);
	OLED_cmd(contrast);
}

void OLED_switch(unsigned char power)//OLED显示开关
{
	if(power)
	{
		OLED_cmd(0xAF);
	}
	else
	{
		OLED_cmd(0xAE);
	}
}

__inline void OLED_set_position(unsigned char column,unsigned char page)//设定页写入模式的page(0-7)与column(0-127)
{
	#ifdef SH1106
	column += 2;
	#endif
	OLED_cmd(0xB0 + page);//设定page
	OLED_cmd(0x0F & column);//设定column的高四位
	OLED_cmd(0x10 + (column >> 4));//设定column的低四位
}

#if CONNECTION==0//IIC
void OLED_bmp(unsigned char x0,unsigned char y0,unsigned char x_lenth,unsigned char y_lenth,const unsigned char *bmp_tab)//显示一幅图片，横坐标范围为0-127，纵坐标范围为0-7
{
	unsigned int k = 0;
	unsigned char x,y;
	for(y = 0;y < y_lenth;y ++)//先行
	{
		OLED_set_position(x0,y0 + y);
		
		IIC_Start();
		IIC_Send_Byte(OLED_ADDR);
		IIC_NAck();
		IIC_Send_Byte(0x40);//写入数据
		IIC_NAck();
		
		for(x = 0;x < x_lenth;x ++)//后列
		{
			IIC_Send_Byte(*(bmp_tab + k));
			IIC_NAck();
			k ++;
		}
		IIC_Stop();
	}
}

void OLED_clear(void)//清屏
{
	unsigned char i,j;
	for(i = 0;i < 8;i ++)//先行
	{
		OLED_set_position(0,i);
		
		IIC_Start();
		IIC_Send_Byte(OLED_ADDR);
		IIC_NAck();
		IIC_Send_Byte(0x40);//写入数据
		IIC_NAck();
		
		for(j = 0;j < 128;j ++)//后列
		{
			IIC_Send_Byte(0);
			IIC_NAck();
		}
		IIC_Stop();
	}
}
#elif CONNECTION==1//软件SPI
void OLED_bmp(unsigned char x0,unsigned char y0,unsigned char x_lenth,unsigned char y_lenth,const unsigned char *bmp_tab)//显示一幅图片，横坐标范围为0-127，纵坐标范围为0-7
{
	unsigned int k = 0;
	unsigned char x,y;
	for(y = 0;y < y_lenth;y ++)//先行
	{
		OLED_set_position(x0,y0 + y);
		OLED_DC = 1;
		for(x = 0;x < x_lenth;x ++)//后列
		{
			OLED_dat(*(bmp_tab + k));
			k ++;
		}
	}
}

void OLED_clear(void)//清屏
{
	unsigned char i,j;
	for(i = 0;i < 8;i ++)//先行
	{
		OLED_set_position(0,i);
		OLED_DC = 1;
		for(j = 0;j < 128;j ++)//后列
		{
			OLED_dat(0);
		}
	}
}

#elif CONNECTION==2//硬件SPI
void OLED_bmp(unsigned char x0,unsigned char y0,unsigned char x_lenth,unsigned char y_lenth,const unsigned char *bmp_tab)//显示一幅图片，横坐标范围为0-127，纵坐标范围为0-7
{
	unsigned int k = 0;
	unsigned char x,y;
	for(y = 0;y < y_lenth;y ++)//先行
	{
		OLED_set_position(x0,y0 + y);
		OLED_DC = 1;
		for(x = 0;x < x_lenth;x ++)//后列
		{
			while(!SPI_SendBusy(OLED_HW_SPI));
			SPI_Buff(OLED_HW_SPI) = *(bmp_tab + k);
			k ++;
		}
	}
}

void OLED_clear(void)//清屏
{
	unsigned char i,j;
	for(i = 0;i < 8;i ++)//先行
	{
		OLED_set_position(0,i);
		#if CONNECTION!=0
		OLED_DC = 1;
		#endif
		for(j = 0;j < 128;j ++)//后列
		{
			while(!SPI_SendBusy(OLED_HW_SPI));
			SPI_Buff(OLED_HW_SPI) = 0;
		}
	}
}
#endif
#ifdef SH1106
void OLED_Shift(unsigned char y)
{
	OLED_cmd(0x40 + y);//从COM0开始显示(0-63)
}

void OLED_Init(void)//初始化
{
	#if CONNECTION==2
	OLED_SPI_Init();//初始化硬件SPI
	#endif
	
	#if CONNECTION!=0//不是IIC
	OLED_Port_Init();//初始化端口
	OLED_RST = 0;//复位OLED
	delay_ms(1);
	OLED_RST = 1;
	#else
	IIC_Init();
	#endif
	
	OLED_cmd(0xA1);//左右不反置(0xA0左右反置 0xA1正常)
	OLED_cmd(0xC8);//上下不反置(0xC0上下反置 0xC8正常)	
	
	OLED_switch(0);//关显示
	OLED_set_position(0,0);//光标归位
	OLED_contrast(0x80);//设置最高亮度
	
	OLED_cmd(0xA6);//不反显(A6正常，A7反显)
	OLED_cmd(0x40);//显示RAM第0行对应纵向COM1(硬件连接的起始)
	OLED_cmd(0xD3);//设置纵向显示偏移(芯片刷新的开始)
	OLED_cmd(0x00);//从COM0开始显示(0-63)
	
	OLED_cmd(0x32);//设定内置电荷泵电压值，默认值8v
	OLED_cmd(0xAD);//设置DC-DC模式
	OLED_cmd(0x8B);//开启内置DC-DC
	
	OLED_cmd(0xA8);//设置刷新率倍数
	OLED_cmd(0x3F);//默认值1/64
	
	OLED_cmd(0xD5);//设置显示时钟分频率和晶振频率
	OLED_cmd(0x50);//时钟频率+0%，不分频(默认值)

	OLED_cmd(0xD9);//设定放电/预充电周期
	OLED_cmd(0x22);//预充电调节2时钟，放电调节2时钟(默认值)
	
	OLED_cmd(0xDA);//设定管脚排列
	OLED_cmd(0x01);//默认顺序
	
	OLED_cmd(0xDB);//设定列驱动电流级别
	OLED_cmd(0x35);//默认值
	
	OLED_clear();
	OLED_switch(1);//开显示
}
#else
void OLED_Shift(unsigned char y)
{
	OLED_cmd(0x40 + y);
}
void OLED_Init(void)//初始化
{
	#if CONNECTION==2
	OLED_SPI_Init();//初始化硬件SPI
	#endif
	
	#if CONNECTION!=0//不是IIC
	OLED_Port_Init();//初始化端口
	OLED_RST = 0;//复位OLED
	delay_ms(1);
	OLED_RST = 1;
	#else
	IIC_Init();
	#endif
	
	OLED_switch(0);//关显示	
	OLED_contrast(0xFF);//最高亮度
	
	OLED_cmd(0xA1);//左右不反置(0xA0左右反置 0xA1正常)
	OLED_cmd(0xC8);//上下不反置(0xC0上下反置 0xC8正常)
	OLED_cmd(0xA6);//不反显(A6正常，A7反显)
	OLED_cmd(0xA4);//正常显示(A4正常显示 A5全屏亮)
	
	OLED_cmd(0xDA);//COM引脚设置(2字节)
	OLED_cmd(0x12);//初始设置
	OLED_cmd(0x40);//RAM第0行对应COM0
	
	OLED_cmd(0xA8);//设置刷新率倍数
	OLED_cmd(0x3F);//默认值1/64
	
	OLED_cmd(0xD3);//设置显示偏移(2字节)
	OLED_cmd(0x00);//不偏移(0-63)
	
	OLED_cmd(0xD5);//设置 振荡器和分频(2字节)
	OLED_cmd(0xF0);//低四位为分频比率，高四位为振荡器频率
	
	OLED_cmd(0xD9);//设定预充电(2字节)
	OLED_cmd(0xF1);//预充电15时钟周期，放电1时钟周期
	
	OLED_cmd(0xDB);//设定列驱动电流级别
	OLED_cmd(0x40);//默认值
	
	OLED_cmd(0x8D);//电荷泵设置
	OLED_cmd(0x14);//开启电荷泵
	
	OLED_cmd(0x20);//逐行写入模式
	OLED_cmd(0x00);
	
	OLED_clear();
	OLED_switch(1);//开显示	
} 
#endif

#ifdef FONT_6_8
#if CONNECTION!=0//不是IIC
void OLED_6_8_Char(unsigned char y,unsigned char x,char ch)
{
	unsigned char i;
	ch -= 32;
	OLED_set_position(x,y);
	for(i = 0;i < 6;i ++)//循环写入6字节
	{
		OLED_dat(F6x8[ch][i]);
	}
}
#else
void OLED_6_8_Char(unsigned char y,unsigned char x,char ch)
{
	unsigned char i;
	ch -= 32;
	
	OLED_set_position(x,y);
	IIC_Start();
	IIC_Send_Byte(OLED_ADDR);
	IIC_NAck();
	IIC_Send_Byte(0x40);//写入数据
	IIC_NAck();
	
	for(i = 0;i < 6;i ++)//循环写入6字节
	{
		IIC_Send_Byte(F6x8[ch][i]);
		IIC_NAck();
	}
	IIC_Stop();
}
#endif
unsigned char OLED_6_8_Number(unsigned char y,unsigned char x,int number,unsigned char digits)
{
	unsigned char dig,minus = 0;//位数
	unsigned int dig_temp;
	unsigned char i;
	unsigned char x_temp = x;
	
	if(number < 0)//判断是否是负数
	{
		minus = 1;
		number = -number;
	}
	dig_temp = 1;
	for(dig = 0;dig < 10;dig ++)//统计位数
	{
		if(number / dig_temp == 0)
			break;
		dig_temp *= 10;
	}
	
	if(digits && dig + minus < digits)//如果输入的数小于规定位数 并且无视位数
	{
		for(i = 0;i < digits-(dig + minus);i ++)//打印空格
		{
			OLED_6_8_Char(y,x_temp,' ');
			x_temp += 6;
		}
	}
	
	if(minus)
	{
		OLED_6_8_Char(y,x_temp,'-');
		x_temp += 6;
	}
	
	dig_temp = 1;
	for(i = 0;i < dig-1;i ++)
	{
		dig_temp *= 10;//将dig_temp指向最高位
	}
	
	for(i = 0;i < dig;i ++)
	{
		OLED_6_8_Char(y,x_temp,'0' + number / dig_temp);
		x_temp += 6;
		
		if(x_temp > 122)
			break;
		
		number *= 10;//扩大十倍
		number %= (dig_temp*10);//将最高位之前的位清除
	}
	
	if(dig + minus < digits)//返回打印的位数
	{
		dig = digits;
	}
	
	if(minus)
	{
		dig ++;
	}
	return dig;
}

void OLED_6_8(unsigned char y,unsigned char x,char string[])//显示6*8字符串
{
	while(*string != '\0')
	{
		if(x > 122 || *string == '\n')//换行
		{
			x = 0;
			y ++;
			if(y > 7)
				break;
		}
		else if(*string<32 || *string>127)
			continue;
		
		OLED_6_8_Char(y,x,*string);//偏移32byte
		
		x += 6;
		string ++;
	}
}
#endif

#ifdef FONT_8_16
#if CONNECTION!=0//如果不是IIC
void OLED_8_16_Char(unsigned char y,unsigned char x,char Font)
{
	unsigned char i;
	Font -= 32;//偏移32byte
	OLED_set_position(x,y);
	for(i = 0;i < 8;i ++)//循环写入上页8字节
	{
		OLED_dat(F8X16[Font][i]);
	}
	OLED_set_position(x,y + 1);
	for(;i < 16;i ++)//循环写入下页8字节
	{
		OLED_dat(F8X16[Font][i]);
	}
}
#else
void OLED_8_16_Char(unsigned char y,unsigned char x,char Font)
{
	unsigned char i;
	Font -= 32;//偏移32byte
	
	OLED_set_position(x,y);
	IIC_Start();
	IIC_Send_Byte(OLED_ADDR);
	IIC_NAck();
	IIC_Send_Byte(0x40);//写入数据
	IIC_NAck();
	
	for(i = 0;i < 8;i ++)//循环写入上页8字节
	{
		IIC_Send_Byte(F8X16[Font][i]);
		IIC_NAck();
	}
	IIC_Stop();
	
	OLED_set_position(x,y + 1);
	IIC_Start();
	IIC_Send_Byte(OLED_ADDR);
	IIC_NAck();
	IIC_Send_Byte(0x40);//写入数据
	IIC_NAck();
	
	for(;i < 16;i ++)//循环写入下页8字节
	{
		IIC_Send_Byte(F8X16[Font][i]);
		IIC_NAck();
	}
	IIC_Stop();
}
#endif

unsigned char OLED_8_16_Number(unsigned char y,unsigned char x,int number,unsigned char digits)
{
	unsigned char dig,minus = 0;//位数
	unsigned int dig_temp;
	unsigned char i;
	unsigned char x_temp = x;
	
	if(number < 0)//判断是否是负数
	{
		minus = 1;
		number = -number;
	}
	dig_temp = 1;
	for(i = 0;i < 10;i ++)//统计位数
	{
		if(number / dig_temp == 0)
			break;
		dig_temp *= 10;
	}
	dig = i;
	
	if(digits && dig + minus < digits)//如果输入的数小于规定位数 并且无视位数
	{
		for(i = 0;i < digits-(dig + minus);i ++)//打印0
		{
			OLED_8_16_Char(y,x_temp,' ');
			x_temp += 8;
		}
	}
	
	if(minus)
	{
		OLED_8_16_Char(y,x_temp,'-');
		x_temp += 8;
	}
	
	dig_temp = 1;
	for(i = 0;i < dig-1;i ++)
	{
		dig_temp *= 10;//将dig_temp指向最高位
	}
	
	for(i = 0;i < dig;i ++)
	{
		OLED_8_16_Char(y,x_temp,'0' + number / dig_temp);
		x_temp += 8;
		
		if(x_temp > 120)
			break;
		
		number *= 10;//扩大十倍
		number %= (dig_temp*10);//将最高位之前的位清除
	}
	
	if(dig + minus < digits)//返回打印的位数
	{
		dig = digits;
	}
	
	if(minus)
	{
		dig ++;
	}
	return dig;
}

void OLED_8_16(unsigned char y,unsigned char x,char* string)
{
	while(*string)
	{
		if(x > 120 || *string == '\n')//换行
		{
			x = 0;
			y += 2;
			if(y > 7)
				break;
		}
		else if(*string<32 || *string>127)
			continue;
		
		OLED_8_16_Char(y,x,*string);//偏移32byte
		
		x += 8;
		string ++;
	}
}
#endif

#ifdef OLED_HAVE_FLASH
void Get_HzMat(unsigned char *Code,unsigned char *mat,unsigned char Size)
{
	unsigned char High8bit,Low8bit;
	unsigned int offset;
	unsigned int NumOfRead;
   High8bit = *Code;//取高8位数据
   Low8bit = *(++Code);//取低8位数据
	//W25Qxx_Read(mat,((High8bit-0xa0-1) * 94 + (Low8bit-0xa0-1)) * 32 + FontOffset,32);
		//此为GB2312编码获取字库的代码
	if(High8bit > 0xFE || High8bit < 0x81)
		return;
	High8bit -= 0x81;
	Low8bit -= 0x40;
	offset = ((unsigned int)192 * High8bit + Low8bit) * Size;//获取GBK编码所指向的汉字的数据
	//W25Qxx_Read(mat,offset,Size);
	
	f_lseek(&FontFile,offset);
	f_read(&FontFile,mat,Size,&NumOfRead);
}

unsigned char OLED_OpenFont(char* FileName)
{
	return f_open(&FontFile,FileName,FA_READ);
}

void OLED_DrawGBK16(unsigned char y,unsigned char x,char* Font)
{
	unsigned char i;
	unsigned char Buff[Font_Buff_Size];
	Get_HzMat((unsigned char*)Font,Buff,Font_Buff_Size);
	
	OLED_set_position(x,y);//上半行

	for(i = 0;i < Font_Size;i ++)
	{
		OLED_dat(Buff[i]);
	}
	
	OLED_set_position(x,y+1);//下半行

	for(;i < Font_Size*2;i ++)
	{
		OLED_dat(Buff[i]);
	}
}

unsigned char OLED_GBK16(unsigned char y,unsigned char x0,const char* str)
{
	unsigned char* s = (unsigned char*)str;
	unsigned char x = x0;
	unsigned char* s0 = s;
	while(*s)
	{
		if (*s < 32)//控制字符
		{
			if(*s == '\n')//换行
			{
				y += Font_Size/8;
				if(y >= OLED_Y)//如果超出了8行
					break;
				x = x0;//光标归位
			}
			s++;//下一个字 ASCII占用一个字节
		}
		else if(*s < 128)//英文或数字
		{
			if(x > OLED_X-Font_Size/2)//横向溢出了
			{
				x = x0;//光标归位
				y += Font_Size/8;
				if(y >= OLED_Y)//如果超出了8行
					break;
			}
			OLED_8_16_Char(y,x,*s);
			x += Font_Size/2;//下一个字 一个ASCII占用8行
			s++;//下一个字 ASCII占用一个字节
		}
		else//如果是汉字
		{
			if(x > OLED_X-Font_Size)//横向溢出了
			{
				x = x0;//光标归位
				y += Font_Size/8;
				if(y >= OLED_Y)//如果超出了8行
					break;
			}
			OLED_DrawGBK16(y,x,(char*)s);//显示汉字
			x += Font_Size;//一个汉字横向长16行
			s += 2;//一个汉字占用2字节
		}
	}
	return (unsigned char)(s - s0);//返回显示的总字符数
}

#endif

void OLED_putc(char ch)
{
	static unsigned char x_pos = 0,y_pos = 0;
	static unsigned char Printf_Overflow = 0;
	unsigned char i;
	
	if(ch == '\n')
	{
		for(i = x_pos;i < 126;i += 6)//清空剩下这行
		{
			OLED_6_8_Char(y_pos,i,' ');
		}
		
		x_pos = 0;
		y_pos ++;
	}
	/*
	else if(ch == '\r')
	{
		x_pos = 0;
	}
	*/
	else if(ch == '\b')
	{
		if(x_pos > 0)
			x_pos -= 6;
		else
		{
			x_pos = 126;
			if(y_pos > 0)
				y_pos --;
			else
				y_pos = 7;
		}
		OLED_6_8_Char(y_pos,x_pos,' ');
	}
	else if(ch == '\f')
	{
		OLED_clear();
		Printf_Overflow = 0;
		x_pos = 0;
		y_pos = 0;
		OLED_Shift(0);
	}
	else if(ch > 31)
	{
		OLED_6_8_Char(y_pos,x_pos,ch);
		x_pos += 6;
	}

	if(x_pos >= 126)//横向超过了
	{
		y_pos ++;
		x_pos = 0;
		for(i = 0;i < 126;i += 6)//清除下一行
		{
			OLED_6_8_Char(y_pos,i,' ');
		}
	}
	
	if(y_pos >= OLED_Y)//纵向超过了
	{
		Printf_Overflow = 1;
		y_pos = 0;
	}
	
	if(Printf_Overflow)
		OLED_Shift(y_pos*8);
}

#ifdef OLED_PRINTF_REMAP
#include <stdio.h>
#pragma import(__use_no_semihosting)
struct __FILE
{ 
	int handle;
};

FILE __stdout;

void _sys_exit(int x)//定义_sys_exit()以避免使用半主机模式
{ 
	x = x; 
}

int fputc(int ch, FILE *f)
{
	OLED_putc((char)ch);
	return ch;
}
#endif
